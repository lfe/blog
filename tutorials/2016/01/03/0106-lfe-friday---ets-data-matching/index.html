

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>
      LFE Blog
      
         - LFE Friday - ETS data matching
      
    </title>
    <meta name="description" content="">
    <meta name="author" content="LFEuminati | Alien Alliance">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link href="/assets/themes/lfe/css/reset.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" type="text/css" href="/assets/themes/lfe/css-social-buttons/css/zocial.stripped.css">
    <link href="/assets/themes/lfe/css/darkstrap.css" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/lfe/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/css/twilight.css" rel="stylesheet" type="text/css" media="all">

    <link href="/assets/themes/lfe/css/lfetheme.css" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/lfe/css/pygments.css" media="screen" rel="stylesheet" type="text/css">
    <link href="/assets/css/overrides.css" rel="stylesheet" type="text/css" media="all">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="LFE News & Updates Atom Feed">
  </head>
  <body class="overview">
    <div id="header-wrapper">
      <div id="header">
        <div>
          <a class="logo" href="/">LFE Blog</a>
          <ul class="nav">
            <li><a href="/archive.html" class="nav-api">Archives</a></li>
            <li><a href="/categories.html" class="nav-developers">Categories</a></li>
            <li><a href="/tags.html" class="nav-developers">Tags</a></li>
            <li><a href="/authors.html">Authors</a></li>
            <li class="divider">|</li>
            <li><a href="http://plan.lfe.io/">.plan</a></li>
            <li><a href="http://docs.lfe.io/">docs.lfe.io</a></li>
            <li><a href="http://lfe.io/">lfe.io</a></li>
          </ul>
        </div>
      </div><!-- #header -->
    </div><!-- #header-wrapper -->

    

<div class="wrapper">
  <div class="container">
    <div class="content">
      
      <div class="page-header">
        <h1>
          LFE Friday - ETS data matching
          
        </h1>
      </div>

      <div class="row">
        <div class="span8">
          
<p><a href="/assets/images/posts/LispFlavoredErlang-medium-square.png"><img class="left tiny" src="/assets/images/posts/LispFlavoredErlang-medium-square.png" /></a>This week's LFE Friday was translated with permission from the
<a href="http://www.proctor-it.com/category/erlang/erlang-thursday/">Erlang Thursday</a>
series by <a href="https://twitter.com/stevenproctor">Steven Proctor</a>.
<em>This week's translator</em>: Robert Virding.</p>

<p>Today's New Year LFE Friday moves on from the introduction to ETS, and starts using it to store some data and do some retrieval of data in ETS.</p>

<p>First we need some data to have in ETS, so we will fall back to one of Proctor's goto problems, Markov Chains.</p>

<p>For those unfamiliar with what a Markov Chain is, it is a state machine that transitions to the next state based off a probability instead of a specific input.  The common example that people are familiar with in "everyday use" is predictive typing on smart phones, where the next word or letter is offered up as a prediction, and the predicted words are chosen by the historical likelihood that the words predicted follows the current word.</p>

<p>The first thing we will do is to create a module that given a string of text, will return a list of tuples representing a word and the word that follows.</p>

<div class="highlight"><pre><code class="language-lisp"><span class="p">(</span><span class="nv">defmodule</span> <span class="nv">markov-words</span>
  <span class="p">(</span><span class="nb">export</span> <span class="p">(</span><span class="nv">create-word-pairs</span> <span class="mi">1</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">create-word-pairs</span> <span class="p">(</span><span class="nv">text</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">words</span> <span class="p">(</span><span class="nv">string:tokens</span> <span class="nv">text</span> <span class="s">&quot; \t\n&quot;</span><span class="p">)))</span>
    <span class="p">(</span><span class="nv">create-word-pairs</span> <span class="nv">words</span> <span class="p">())))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">create-word-pairs</span>
  <span class="p">(((</span><span class="nb">list*</span> <span class="nv">word</span> <span class="nv">following</span> <span class="nv">words</span><span class="p">)</span> <span class="nv">word-pairs</span><span class="p">)</span>
   <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">updated-word-pairs</span> <span class="o">`</span><span class="p">(</span><span class="o">#(,</span><span class="nv">word</span> <span class="o">,</span><span class="nv">following</span><span class="p">)</span> <span class="o">.</span> <span class="o">,</span><span class="nv">word-pairs</span><span class="p">)))</span>
     <span class="p">(</span><span class="nv">create-word-pairs</span> <span class="p">(</span><span class="nb">cons</span> <span class="nv">following</span> <span class="nv">words</span><span class="p">)</span> <span class="nv">updated-word-pairs</span><span class="p">)))</span>
  <span class="p">((</span><span class="nv">words</span> <span class="nv">word-pairs</span><span class="p">)</span> <span class="nv">word-pairs</span><span class="p">))</span></code></pre></div>

<p>The above code takes a string of text and splits that text into "words" based off using the space, tab, and newline characters as a word boundary.  With that list of "words", we then create a list of word to following word tuples, which is what we will be inserting into our ETS table.</p>

<p>Time to fire up the Erlang shell and start experimenting.</p>

<p>We first save the text we want to use in the file <code>tail-of-two-cities.txt</code>.</p>

<div class="highlight"><pre><code class="language-bash"><span class="nv">$ </span> cat &gt; tail-of-two-cities.txt
It was the best of <span class="nb">times</span>, it was the worst of <span class="nb">times</span>,
it was the age of wisdom, it was the age of foolishness,
it was the epoch of belief, it was the epoch of incredulity,
it was the season of Light, it was the season of Darkness,
it was the spring of hope, it was the winter of despair,
we had everything before us, we had nothing before us,
we were all going direct to Heaven,
we were all going direct the other way--in short,
the period was so far like the present period,
that some of its noisiest authorities insisted on its
being received, <span class="k">for</span> good or <span class="k">for</span> evil, in the superlative
degree of comparison only.

There were a king with a large jaw and a queen with a
plain face, on the throne of England<span class="p">;</span> there were a king
with a large jaw and a queen with a fair face,
on the throne of France. In both countries it was
clearer than crystal to the lords of the State preserves
of loaves and fishes, that things in general were
settled <span class="k">for</span> ever.</code></pre></div>

<p>We then need to compile our module, and then we will create the variable <code>totc</code> to hold the text from the file which we want to use to prime our Markov Chain.</p>

<div class="highlight"><pre><code class="language-lisp"><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">c</span> <span class="ss">&#39;markov-words</span><span class="p">)</span>
<span class="p">(</span><span class="o">#(</span><span class="nv">module</span> <span class="nv">markov-words</span><span class="p">))</span>
<span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="nv">totc</span> <span class="p">(</span><span class="nv">binary_to_list</span> <span class="p">(</span><span class="nv">element</span> <span class="mi">2</span> <span class="p">(</span><span class="nv">file:read_file</span> <span class="s">&quot;tail-of-two-cities.txt&quot;</span><span class="p">))))</span>
<span class="s">&quot;It was the best of times, it was the worst of times,\nit was the age of wisdom, it was the age of foolishness,\nit was the epoch of belief, it was the epoch of incredulity,\nit was the season of Light, it was the season of Darkness,\nit was the spring of hope, it was the winter of despair,\nwe had everything before us, we had nothing before us,\nwe were all going direct to Heaven,\nwe were all going direct the other way--in short,\nthe period was so far like the present period,\nthat some of its noisiest authorities insisted on its\nbeing received, for good or for evil, in the superlative\ndegree of comparison only.\n\nThere were a king with a large jaw and a queen with a\nplain face, on the throne of England; there were a king\nwith a large jaw and a queen with a fair face,\non the throne of France. In both countries it was\nclearer than crystal to the lords of the State preserves\nof loaves and fishes, that things in general were\nsettled for ever.\n&quot;</span></code></pre></div>

<p>We will create a new process to give our ETS table away to, just in case we bomb out the shell.</p>

<div class="highlight"><pre><code class="language-lisp"><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="nv">fun</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">()</span> <span class="p">(</span><span class="nv">receive</span> <span class="p">(</span><span class="nv">after</span> <span class="ss">&#39;infinity</span> <span class="ss">&#39;ok</span><span class="p">))))</span>
<span class="err">#</span><span class="nv">Fun&lt;lfe_eval.23.88887576&gt;</span>
<span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="nv">some-process</span> <span class="p">(</span><span class="nv">spawn</span> <span class="nv">fun</span><span class="p">))</span>
<span class="nv">&lt;0.43.0&gt;</span></code></pre></div>

<p>And we now create an ETS table that will store data for us to use as part of our Markov Chain generation.</p>

<div class="highlight"><pre><code class="language-lisp"><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="nv">word-pairs</span> <span class="p">(</span><span class="nv">ets:new</span> <span class="ss">&#39;word-pairs</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">public</span> <span class="nv">duplicate_bag</span><span class="p">)))</span>
<span class="mi">8207</span>
<span class="nb">&gt;</span> <span class="p">(</span><span class="nv">ets:give_away</span> <span class="nv">word-pairs</span> <span class="nv">some-process</span> <span class="p">())</span>
<span class="nv">true</span></code></pre></div>

<p>We make the table <code>public</code> in this case, since we want our shell process, which is no longer the owner, to be able to add items to the table, and we make the table type a duplicate bag.</p>

<p>The reason for the <code>duplicate_bag</code>, is that for demonstration reasons, we want to be able to have multiple entries with the same key, as we are likely to see any word multiple times, and that some sets of word pairs are more common, so we want to be able to capture (and retain) those "duplicates".</p>

<p>And for ease of population from inside the shell, we will use a list comprehension to add each word pair tuple we create from the text into our ETS table by calling <code>ets:insert/2</code>.</p>

<div class="highlight"><pre><code class="language-lisp"><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">list-comp</span> <span class="p">((</span><span class="nv">&lt;-</span> <span class="nv">word-pair</span> <span class="p">(</span><span class="nv">markov-words:create-word-pairs</span> <span class="nv">totc</span><span class="p">)))</span> <span class="p">(</span><span class="nv">ets:insert</span> <span class="nv">word-pairs</span> <span class="nv">word-pair</span><span class="p">))</span>
<span class="p">(</span><span class="nv">true</span> <span class="nv">true</span> <span class="nv">true</span> <span class="nv">true</span> <span class="nv">true</span> <span class="nv">true</span> <span class="nv">true</span> <span class="nv">true</span> <span class="nv">true</span> <span class="nv">true</span> <span class="nv">true</span> <span class="nv">true</span> <span class="nv">true</span>
 <span class="nv">true</span> <span class="nv">true</span> <span class="nv">true</span> <span class="nv">true</span> <span class="nv">true</span> <span class="nv">true</span> <span class="nv">true</span> <span class="nv">true</span> <span class="nv">true</span> <span class="nv">true</span> <span class="nv">true</span> <span class="nv">true</span> <span class="nv">true</span>
 <span class="nv">true</span> <span class="nv">true</span> <span class="nv">true</span> <span class="nv">true</span> <span class="o">...</span><span class="p">)</span></code></pre></div>

<p>Now we should have some data in our ETS table, it is time to see how we can access our data.  For this we turn to <a href="http://www.erlang.org/doc/man/ets.html#match-2">ets:match/2</a>.  <code>ets:match/2</code> takes a table to query, and a <code>pattern</code>.</p>

<p>The pattern is made up an Erlang term to be matched against; <code>_</code>, which matches anything and doesn't bind; or pattern variables, which take the form of <code>$N</code> where <code>N</code> is any non-negative integer.  The return result of <code>ets:match/2</code> is a list containing the list of values in the pattern variables in order of variable name order.</p>

<p>So with this knowledge, we can try to find the word pairs to find the words that follow <code>"of"</code>.  If we were doing a pattern match it would look like <code>(tuple "of" following)</code>, but using ETS, we need to use a pattern variable which would make our spec <code>#("of" $1)</code>.</p>

<p>So lets run that against our ETS table.</p>

<div class="highlight"><pre><code class="language-lisp"><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">ets:match</span> <span class="nv">word-pairs</span> <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="nv">$1</span><span class="p">))</span>
<span class="p">((</span><span class="s">&quot;loaves&quot;</span><span class="p">)</span>
 <span class="p">(</span><span class="s">&quot;the&quot;</span><span class="p">)</span>
 <span class="p">(</span><span class="s">&quot;France.&quot;</span><span class="p">)</span>
 <span class="p">(</span><span class="s">&quot;England;&quot;</span><span class="p">)</span>
 <span class="p">(</span><span class="s">&quot;comparison&quot;</span><span class="p">)</span>
 <span class="p">(</span><span class="s">&quot;its&quot;</span><span class="p">)</span>
 <span class="p">(</span><span class="s">&quot;despair,&quot;</span><span class="p">)</span>
 <span class="p">(</span><span class="s">&quot;hope,&quot;</span><span class="p">)</span>
 <span class="p">(</span><span class="s">&quot;Darkness,&quot;</span><span class="p">)</span>
 <span class="p">(</span><span class="s">&quot;Light,&quot;</span><span class="p">)</span>
 <span class="p">(</span><span class="s">&quot;incredulity,&quot;</span><span class="p">)</span>
 <span class="p">(</span><span class="s">&quot;belief,&quot;</span><span class="p">)</span>
 <span class="p">(</span><span class="s">&quot;foolishness,&quot;</span><span class="p">)</span>
 <span class="p">(</span><span class="s">&quot;wisdom,&quot;</span><span class="p">)</span>
 <span class="p">(</span><span class="s">&quot;times,&quot;</span><span class="p">)</span>
 <span class="p">(</span><span class="s">&quot;times,&quot;</span><span class="p">))</span></code></pre></div>

<p>And there we go, we can see the results is a list of the list of variable matches, in this case, just what <code>$1</code> matched to.</p>

<p>For fun and exploration, let's confirm what we would get if we look for the words that follow <code>"it"</code> in our Tale of Two Cities intro text.</p>

<div class="highlight"><pre><code class="language-lisp"><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">ets:match</span> <span class="nv">word-pairs</span> <span class="o">#(</span><span class="s">&quot;it&quot;</span> <span class="nv">$1</span><span class="p">))</span>
<span class="p">((</span><span class="s">&quot;was&quot;</span><span class="p">)</span>
 <span class="p">(</span><span class="s">&quot;was&quot;</span><span class="p">)</span>
 <span class="p">(</span><span class="s">&quot;was&quot;</span><span class="p">)</span>
 <span class="p">(</span><span class="s">&quot;was&quot;</span><span class="p">)</span>
 <span class="p">(</span><span class="s">&quot;was&quot;</span><span class="p">)</span>
 <span class="p">(</span><span class="s">&quot;was&quot;</span><span class="p">)</span>
 <span class="p">(</span><span class="s">&quot;was&quot;</span><span class="p">)</span>
 <span class="p">(</span><span class="s">&quot;was&quot;</span><span class="p">)</span>
 <span class="p">(</span><span class="s">&quot;was&quot;</span><span class="p">)</span>
 <span class="p">(</span><span class="s">&quot;was&quot;</span><span class="p">))</span></code></pre></div>

<p>Just a bunch of <code>"was"</code> which is right for the first two paragraphs of the book.</p>

<p>And we will double check and look for any words that follow <code>"Scrooge"</code>.</p>

<div class="highlight"><pre><code class="language-lisp"><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">ets:match</span> <span class="nv">word-pairs</span> <span class="o">#(</span><span class="s">&quot;Scrooge&quot;</span> <span class="nv">$1</span><span class="p">))</span>
<span class="p">()</span></code></pre></div>

<p>And if we wanted to get the whole tuple back, we could use <code>ets:match_object/2</code>, which will return the whole object that satisfies the match</p>

<div class="highlight"><pre><code class="language-lisp"><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">ets:match_object</span> <span class="nv">word-pairs</span> <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="nv">$1</span><span class="p">))</span>
<span class="p">(</span><span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;loaves&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;the&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;France.&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;England;&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;comparison&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;its&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;despair,&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;hope,&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;Darkness,&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;Light,&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;incredulity,&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;belief,&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;foolishness,&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;wisdom,&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;times,&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;times,&quot;</span><span class="p">))</span></code></pre></div>

<p>or, in this case we could use <code>ets:lookup/2</code> which returns all of the items for which the key matches.</p>

<div class="highlight"><pre><code class="language-lisp"><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">ets:lookup</span> <span class="nv">word-pairs</span> <span class="s">&quot;of&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;loaves&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;the&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;France.&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;England;&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;comparison&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;its&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;despair,&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;hope,&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;Darkness,&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;Light,&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;incredulity,&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;belief,&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;foolishness,&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;wisdom,&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;times,&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;times,&quot;</span><span class="p">))</span></code></pre></div>

<p>So to take a brief detour away from the Markov Chain example, why might we want to use either <code>ets:lookup/2</code> or <code>ets:match_object/2</code> versus the other?  To answer that with an example, let's add another entry into our <code>word-pairs</code> table, that is a three-tuple.</p>

<div class="highlight"><pre><code class="language-lisp"><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">ets:insert</span> <span class="nv">word-pairs</span> <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;times&quot;</span> <span class="s">&quot;it&quot;</span><span class="p">))</span>
<span class="nv">true</span></code></pre></div>

<p>If we do a <code>ets:lookup/2</code> we get all items with the specified key.</p>

<div class="highlight"><pre><code class="language-lisp"><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">ets:lookup</span> <span class="nv">word-pairs</span> <span class="s">&quot;of&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;loaves&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;the&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;France.&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;England;&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;comparison&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;its&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;despair,&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;hope,&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;Darkness,&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;Light,&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;incredulity,&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;belief,&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;foolishness,&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;wisdom,&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;times,&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;times,&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;times&quot;</span> <span class="s">&quot;it&quot;</span><span class="p">))</span></code></pre></div>

<p>But if we use <code>ets:match_object/2</code>, and use a two-tuple because we only want the word <em>pairs</em>, we don't get the item that is a three-tuple in the results.</p>

<div class="highlight"><pre><code class="language-lisp"><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">ets:match_object</span> <span class="nv">word-pairs</span> <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="nv">_</span><span class="p">))</span>
<span class="p">(</span><span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;loaves&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;the&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;France.&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;England;&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;comparison&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;its&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;despair,&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;hope,&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;Darkness,&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;Light,&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;incredulity,&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;belief,&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;foolishness,&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;wisdom,&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;times,&quot;</span><span class="p">)</span>
 <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="s">&quot;times,&quot;</span><span class="p">))</span></code></pre></div>

<p>Back to the Markov Chain scenario, we can start to see how we can get some text that follows the Markov Chain rules.</p>

<p>We get the match of potential words to choose from for a given word, and we pick a uniformly random result from the list of following words.</p>

<div class="highlight"><pre><code class="language-lisp"><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="nv">potential-choices</span> <span class="p">(</span><span class="nv">ets:match</span> <span class="nv">word-pairs</span> <span class="o">#(</span><span class="s">&quot;of&quot;</span> <span class="nv">$1</span><span class="p">)))</span>
<span class="p">((</span><span class="s">&quot;loaves&quot;</span><span class="p">)</span>
 <span class="p">(</span><span class="s">&quot;the&quot;</span><span class="p">)</span>
 <span class="p">(</span><span class="s">&quot;France.&quot;</span><span class="p">)</span>
 <span class="p">(</span><span class="s">&quot;England;&quot;</span><span class="p">)</span>
 <span class="p">(</span><span class="s">&quot;comparison&quot;</span><span class="p">)</span>
 <span class="p">(</span><span class="s">&quot;its&quot;</span><span class="p">)</span>
 <span class="p">(</span><span class="s">&quot;despair,&quot;</span><span class="p">)</span>
 <span class="p">(</span><span class="s">&quot;hope,&quot;</span><span class="p">)</span>
 <span class="p">(</span><span class="s">&quot;Darkness,&quot;</span><span class="p">)</span>
 <span class="p">(</span><span class="s">&quot;Light,&quot;</span><span class="p">)</span>
 <span class="p">(</span><span class="s">&quot;incredulity,&quot;</span><span class="p">)</span>
 <span class="p">(</span><span class="s">&quot;belief,&quot;</span><span class="p">)</span>
 <span class="p">(</span><span class="s">&quot;foolishness,&quot;</span><span class="p">)</span>
 <span class="p">(</span><span class="s">&quot;wisdom,&quot;</span><span class="p">)</span>
 <span class="p">(</span><span class="s">&quot;times,&quot;</span><span class="p">)</span>
 <span class="p">(</span><span class="s">&quot;times,&quot;</span><span class="p">))</span>
<span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="p">(</span><span class="nb">list</span> <span class="nv">next-word</span><span class="p">)</span> <span class="p">(</span><span class="nv">lists:nth</span> <span class="p">(</span><span class="nv">random:uniform</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">potential-choices</span><span class="p">))</span> <span class="nv">potential-choices</span><span class="p">))</span>
<span class="p">(</span><span class="s">&quot;hope,&quot;</span><span class="p">)</span></code></pre></div>

<p>We can write a function that will repeat these steps until we get to our termination case. Some examples of a termination state could be a word that doesn't have a word that follows it; we get to a certain number of words picked to make up our text; or we get to a certain total length, say to fit in a SMS or Tweet.</p>

<p>With that, we have started to scratch the surface of putting some "real" data into ETS, and doing matching against the data for some given pattern.  Next week we will continue looking at this example with other ways to get data out of our ETS tables into something that might be nicer to consume.</p>

<p>- Proctor, Robert</p>

          <hr>
          <div class="pagination btn-group">
            
            <a class="btn prev" href="/tutorials/2015/12/25/2138-lfe-friday---ets-introduction-part-5" title="LFE Friday - ETS Introduction, part 5: keypos, read_concurrency and write_concurrency">&larr; Previous</a>
            
            <a class="btn" href="/archive.html">Archive</a>
            
            <a class="btn next" href="/tutorials/2016/01/10/2016-lfe-friday---more-ets-data-matching" title="LFE Friday - More ETS data matching (and querying)">Next &rarr;</a>
            
          </div>
          <hr>
          
        </div>

        <div class="span4">
          <section>
            <h4>Author</h4>
            <div class="author"><span><a href="/authors.html#Robert Virding">Robert Virding</a></span></div>
          </section>
          <section>
            <h4>Published</h4>
            <div class="date"><span>03 January 2016</span></div>
          </section>
          
          <section>
            <h4>Category</h4>
            <span class="category">
              tutorials
            </span>
          </section>
          
          
          <section>
            <h4>Tags</h4>
            <ul class="tag_box">
              
              


  
     
    	<li><a href="/tags.html#lfe friday-ref">lfe friday <span>58</span></a></li>
     
    	<li><a href="/tags.html#lfe-ref">lfe <span>63</span></a></li>
     
    	<li><a href="/tags.html#erlang-ref">erlang <span>71</span></a></li>
    
  



            </ul>
          </section>
          
        </div>
      </div>


    </div>
  </div> <!-- /container -->
</div>




    <div id="footer" >
    <div class="lower_footer">
      <ul class="footer-cell">
        <li><a href="/archive.html">Archives</a></li>
        <li><a href="/categories.html">Categories</a></li>
        <li><a href="/tags.html">Tags</a></li>
        <li><a href="/authors.html">Authors</a></li>
        <li><a href="/pages.html">Pages</a></li>
      </ul>

      <span class="footer-cell">
        <a href="/"><img src="/assets/themes/lfe/images/logo-white.png"/></a>
      </span>

      <ul class="footer-cell">
        <li><a href="http://github.com/lfex">lfex</a></li>
        <li><a href="https://groups.google.com/forum/#!forum/lisp-flavoured-erlang">List</a></li>
        <li><a href="http://webchat.freenode.net/?channels=erlang-lisp">IRC</a></li>
        <li><a href="http://feeds.feedburner.com/lfe/news-and-updates">RSS</a></li>
        <li><a href="http://twitter.com/ErlangLisp">Twitter</a></li>
        <li><a href="http://github.com/rvirding/lfe">Github</a></li>
      </ul>
    </div>

    <div class="wrapper">
      <p>Original Design &copy; <span class="js-year"></span> GitHub, Inc.</p>
      <p>LFE Design and Content &copy; <span class="js-year"></span> LFEuminati | Alien Alliance</p>
    </div>

  </div><!-- /#footer -->

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="/assets/themes/lfe/js/jquery.min.js"><\/script>')</script>
    <script src="/assets/themes/lfe/bootstrap/js/bootstrap.min.js"></script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-38274766-2', 'auto');
      ga('send', 'pageview');

    </script>
  </body>
</html>

