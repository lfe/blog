

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>
      LFE Blog
      
         - Coming in LFE v1.0: exporting macros
      
    </title>
    <meta name="description" content="">
    <meta name="author" content="LFEuminati | Alien Alliance">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link href="/assets/themes/lfe/css/reset.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" type="text/css" href="/assets/themes/lfe/css-social-buttons/css/zocial.stripped.css">
    <link href="/assets/themes/lfe/css/darkstrap.css" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/lfe/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/css/twilight.css" rel="stylesheet" type="text/css" media="all">

    <link href="/assets/themes/lfe/css/lfetheme.css" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/lfe/css/pygments.css" media="screen" rel="stylesheet" type="text/css">
    <link href="/assets/css/overrides.css" rel="stylesheet" type="text/css" media="all">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="LFE News & Updates Atom Feed">
  </head>
  <body class="overview">
    <div id="header-wrapper">
      <div id="header">
        <div>
          <a class="logo" href="/">LFE Blog</a>
          <ul class="nav">
            <li><a href="/archive.html" class="nav-api">Archives</a></li>
            <li><a href="/categories.html" class="nav-developers">Categories</a></li>
            <li><a href="/tags.html" class="nav-developers">Tags</a></li>
            <li><a href="/authors.html">Authors</a></li>
            <li class="divider">|</li>
            <li><a href="http://plan.lfe.io/">.plan</a></li>
            <li><a href="http://docs.lfe.io/">docs.lfe.io</a></li>
            <li><a href="http://lfe.io/">lfe.io</a></li>
          </ul>
        </div>
      </div><!-- #header -->
    </div><!-- #header-wrapper -->

    

<div class="wrapper">
  <div class="container">
    <div class="content">
      
      <div class="page-header">
        <h1>
          Coming in LFE v1.0: exporting macros
          
        </h1>
      </div>

      <div class="row">
        <div class="span8">
          
<p><a href="/assets/images/posts/LFE-signal.jpg"><img class="right thumb" src="/assets/images/posts/LFE-signal.jpg" /></a>Here are some more new things which are coming in LFE v1.0. These can also be tested on the develop branch.
<br /><br /></p>

<p>The next new feature is being able to export macros from a module in the same way as exporting functions. Until now macros have had to be defined locally within a module to access them. The standard way of importing macros has been to include a file defining these macros. The exported macros can be "called" from other modules in the same way as functions but they are macros and it is their expansion which is inserted into the code.</p>

<p>As an example we will take the record <code>foo</code> which could be defined as <code>(defrecord foo a b)</code> but instead define it in a module which exports (a subset of) the standard record access macros for <code>foo</code>. The module basically mirrors the expansion of the <code>defrecord</code> macro into access macros and internal functions. <sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup></p>

<div class="highlight"><pre><code class="language-lisp"><span class="c1">;; Define the record foo as a module and export the macros.</span>
<span class="c1">;; (defrecord foo a b)</span>

<span class="p">(</span><span class="nv">defmodule</span> <span class="nv">foo</span>
  <span class="p">(</span><span class="nv">export-macro</span> <span class="nv">make</span> <span class="nv">match</span> <span class="nv">is</span> <span class="nv">a</span> <span class="nv">set-a</span> <span class="nv">b</span> <span class="nv">set-b</span><span class="p">))</span>

<span class="c1">;; Functions defining and accessing the foo record internals.</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">field-index</span>
  <span class="p">(</span><span class="nv">[</span><span class="ss">&#39;a]</span> <span class="mi">2</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">[</span><span class="ss">&#39;b]</span> <span class="mi">3</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">[f]</span> <span class="p">(</span><span class="nv">erlang:error</span> <span class="p">(</span><span class="nv">tuple</span> <span class="ss">&#39;undefined-field</span> <span class="ss">&#39;foo</span> <span class="nv">f</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">field-loop</span>
  <span class="p">(</span><span class="nv">[</span><span class="p">(</span><span class="nb">cons</span> <span class="nv">field</span> <span class="p">(</span><span class="nb">cons</span> <span class="nv">val</span> <span class="nv">fields</span><span class="p">))</span> <span class="nv">i]</span>
   <span class="p">(</span><span class="nv">field-loop</span> <span class="nv">fields</span> <span class="p">(</span><span class="nv">setelement</span> <span class="p">(</span><span class="nb">-</span> <span class="p">(</span><span class="nv">field-index</span> <span class="nv">field</span><span class="p">)</span> <span class="mi">1</span><span class="p">)</span> <span class="nv">i</span> <span class="nv">val</span><span class="p">)))</span>
  <span class="p">(</span><span class="nv">[</span><span class="p">(</span><span class="nb">list</span> <span class="nv">f</span><span class="p">)</span> <span class="nv">_]</span>
   <span class="p">(</span><span class="err">:</span> <span class="nv">erlang</span> <span class="nb">error</span> <span class="p">(</span><span class="nv">tuple</span> <span class="ss">&#39;missing_value</span> <span class="ss">&#39;foo</span> <span class="nv">f</span><span class="p">)))</span>
  <span class="p">(</span><span class="nv">[</span><span class="p">()</span> <span class="nv">i]</span> <span class="nv">i</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">field-update</span> <span class="p">(</span><span class="nv">field-inits</span> <span class="nv">def</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">i</span> <span class="p">(</span><span class="nv">field-loop</span> <span class="nv">field-inits</span> <span class="p">(</span><span class="nv">list_to_tuple</span> <span class="nv">def</span><span class="p">))))</span>
    <span class="p">(</span><span class="nv">tuple_to_list</span> <span class="nv">i</span><span class="p">)))</span>

<span class="c1">;; The foo record access macros.</span>

<span class="p">(</span><span class="nb">defmacro</span> <span class="nv">make</span> <span class="nv">fields</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">def</span> <span class="p">(</span><span class="nb">list</span> <span class="o">&#39;</span><span class="ss">&#39;undefined</span> <span class="o">&#39;</span><span class="ss">&#39;undefined</span><span class="p">)))</span>
    <span class="o">`</span><span class="p">(</span><span class="nv">tuple</span> <span class="ss">&#39;foo</span> <span class="o">,@</span><span class="p">(</span><span class="nv">field-update</span> <span class="nv">fields</span> <span class="nv">def</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">defmacro</span> <span class="nv">match</span> <span class="nv">fields</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">def</span> <span class="p">(</span><span class="nb">list</span> <span class="ss">&#39;_</span> <span class="ss">&#39;_</span><span class="p">)))</span>
    <span class="o">`</span><span class="p">(</span><span class="nv">tuple</span> <span class="ss">&#39;foo</span> <span class="o">,@</span><span class="p">(</span><span class="nv">field-update</span> <span class="nv">fields</span> <span class="nv">def</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">defmacro</span> <span class="nv">is</span> <span class="p">(</span><span class="nv">rec</span><span class="p">)</span>
  <span class="o">`</span><span class="p">(</span><span class="nv">is_record</span> <span class="o">,</span><span class="nv">rec</span> <span class="ss">&#39;foo</span> <span class="mi">3</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defmacro</span> <span class="nv">a</span> <span class="p">(</span><span class="nv">rec</span><span class="p">)</span> <span class="o">`</span><span class="p">(</span><span class="nv">element</span> <span class="mi">2</span> <span class="o">,</span><span class="nv">rec</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defmacro</span> <span class="nv">set-a</span> <span class="p">(</span><span class="nv">rec</span> <span class="nv">new</span><span class="p">)</span>
  <span class="o">`</span><span class="p">(</span><span class="nv">setelement</span> <span class="mi">2</span> <span class="o">,</span><span class="nv">rec</span> <span class="o">,</span><span class="nv">new</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defmacro</span> <span class="nv">b</span> <span class="p">(</span><span class="nv">rec</span><span class="p">)</span> <span class="o">`</span><span class="p">(</span><span class="nv">element</span> <span class="mi">3</span> <span class="o">,</span><span class="nv">rec</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defmacro</span> <span class="nv">set-b</span> <span class="p">(</span><span class="nv">rec</span> <span class="nv">new</span><span class="p">)</span>
  <span class="o">`</span><span class="p">(</span><span class="nv">setelement</span> <span class="mi">3</span> <span class="o">,</span><span class="nv">rec</span> <span class="o">,</span><span class="nv">new</span><span class="p">))</span></code></pre></div>

<p>We can now compile the module <code>foo</code> and call the macros. First we will call the <code>foo:make</code> macro to create an instance of <code>foo</code> and also show its expansion.</p>

<div class="highlight"><pre><code class="language-lisp"><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">c</span> <span class="s">&quot;foo&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="o">#(</span><span class="nv">module</span> <span class="nv">foo</span><span class="p">))</span>
<span class="nb">&gt;</span> <span class="p">(</span><span class="nb">macroexpand</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">foo:make</span> <span class="nv">b</span> <span class="mi">15</span> <span class="nv">a</span> <span class="mi">14</span><span class="p">))</span>
<span class="p">(</span><span class="nv">tuple</span> <span class="ss">&#39;foo</span> <span class="mi">14</span> <span class="mi">15</span><span class="p">)</span>
<span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="nv">foo-rec</span> <span class="p">(</span><span class="nv">foo:make</span> <span class="nv">b</span> <span class="mi">15</span> <span class="nv">a</span> <span class="mi">14</span><span class="p">))</span>
<span class="o">#(</span><span class="nv">foo</span> <span class="mi">14</span> <span class="mi">15</span><span class="p">)</span></code></pre></div>

<p>While creating instances can be done with functions matching <code>foo</code> records must be done with macros. The <code>foo:match</code> macro does this for us. We will now use it and again also show its expansion.</p>

<div class="highlight"><pre><code class="language-lisp"><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">macroexpand</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">foo:match</span> <span class="nv">b</span> <span class="nv">b-val</span><span class="p">))</span>        
<span class="p">(</span><span class="nv">tuple</span> <span class="ss">&#39;foo</span> <span class="nv">_</span> <span class="nv">b-val</span><span class="p">)</span>
<span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="p">(</span><span class="nv">foo:match</span> <span class="nv">b</span> <span class="nv">b-val</span><span class="p">)</span> <span class="nv">foo-rec</span><span class="p">)</span>         
<span class="o">#(</span><span class="nv">foo</span> <span class="mi">14</span> <span class="mi">15</span><span class="p">)</span>
<span class="nb">&gt;</span> <span class="nv">b-val</span>
<span class="mi">15</span></code></pre></div>

<p>The final example is the <code>foo:is</code> macro which tests whether its argument is a foo record.</p>

<div class="highlight"><pre><code class="language-lisp"><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">macroexpand</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">foo:is</span> <span class="nv">foo-rec</span><span class="p">))</span>   
<span class="p">(</span><span class="nv">is_record</span> <span class="nv">foo-rec</span> <span class="ss">&#39;foo</span> <span class="mi">3</span><span class="p">)</span>
<span class="nb">&gt;</span> <span class="p">(</span><span class="nv">foo:is</span> <span class="nv">foo-rec</span><span class="p">)</span>               
<span class="nv">true</span>
<span class="nb">&gt;</span> <span class="p">(</span><span class="nv">foo:is</span> <span class="o">#(</span><span class="nv">bar</span> <span class="mi">34</span> <span class="mi">35</span><span class="p">))</span>
<span class="nv">false</span></code></pre></div>

<p>This will present a much more unified interface to modules, also making it easier to use macros as functions of a variable number of arguments. Including files containing macros will of course still be supported.</p>

<h2 id="addendum">ADDENDUM</h2>

<p>LFE actually allows you to redefine the predefined macros. However, if you have done this you can still access the original predefined macros by calling them in the <code>lfe</code> module. For example <code>(lfe:cond ...)</code> will expand using the predefined <code>cond</code> macro even if it has been locally defined.</p>

<p>You can also define macros with the same names as the core forms but these will silently be ignored. There are limits to how much harm we allow you to do to yourself.</p>

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>To see the full expansion of the <code>defrecord</code> macro do <code>(macroexpand '(defrecord foo a b))</code>. <a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

          <hr>
          <div class="pagination btn-group">
            
            <a class="btn prev" href="/tutorials/2016/03/03/0104-lfe-v10-multi-module-files" title="Coming in LFE v1.0: multi-module files">&larr; Previous</a>
            
            <a class="btn" href="/archive.html">Archive</a>
            
            <a class="btn next" href="/tutorials/2016/03/25/0858-lfe-and-rebar3" title="LFE and rebar3">Next &rarr;</a>
            
          </div>
          <hr>
          
        </div>

        <div class="span4">
          <section>
            <h4>Author</h4>
            <div class="author"><span><a href="/authors.html#Robert Virding">Robert Virding</a></span></div>
          </section>
          <section>
            <h4>Published</h4>
            <div class="date"><span>05 March 2016</span></div>
          </section>
          
          <section>
            <h4>Category</h4>
            <span class="category">
              tutorials
            </span>
          </section>
          
          
          <section>
            <h4>Tags</h4>
            <ul class="tag_box">
              
              


  
     
    	<li><a href="/tags.html#v1.0-ref">v1.0 <span>2</span></a></li>
    
  



            </ul>
          </section>
          
        </div>
      </div>


    </div>
  </div> <!-- /container -->
</div>




    <div id="footer" >
    <div class="lower_footer">
      <ul class="footer-cell">
        <li><a href="/archive.html">Archives</a></li>
        <li><a href="/categories.html">Categories</a></li>
        <li><a href="/tags.html">Tags</a></li>
        <li><a href="/authors.html">Authors</a></li>
        <li><a href="/pages.html">Pages</a></li>
      </ul>

      <span class="footer-cell">
        <a href="/"><img src="/assets/themes/lfe/images/logo-white.png"/></a>
      </span>

      <ul class="footer-cell">
        <li><a href="http://github.com/lfex">lfex</a></li>
        <li><a href="https://groups.google.com/forum/#!forum/lisp-flavoured-erlang">List</a></li>
        <li><a href="http://webchat.freenode.net/?channels=erlang-lisp">IRC</a></li>
        <li><a href="http://feeds.feedburner.com/lfe/news-and-updates">RSS</a></li>
        <li><a href="http://twitter.com/ErlangLisp">Twitter</a></li>
        <li><a href="http://github.com/rvirding/lfe">Github</a></li>
      </ul>
    </div>

    <div class="wrapper">
      <p>Original Design &copy; <span class="js-year"></span> GitHub, Inc.</p>
      <p>LFE Design and Content &copy; <span class="js-year"></span> LFEuminati | Alien Alliance</p>
    </div>

  </div><!-- /#footer -->

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="/assets/themes/lfe/js/jquery.min.js"><\/script>')</script>
    <script src="/assets/themes/lfe/bootstrap/js/bootstrap.min.js"></script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-38274766-2', 'auto');
      ga('send', 'pageview');

    </script>
  </body>
</html>

