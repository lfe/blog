

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>
      LFE Blog
      
         - LFE Friday - ETS Introduction, part 2
      
    </title>
    <meta name="description" content="">
    <meta name="author" content="LFEuminati | Alien Alliance">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link href="/assets/themes/lfe/css/reset.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" type="text/css" href="/assets/themes/lfe/css-social-buttons/css/zocial.stripped.css">
    <link href="/assets/themes/lfe/css/darkstrap.css" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/lfe/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/css/twilight.css" rel="stylesheet" type="text/css" media="all">

    <link href="/assets/themes/lfe/css/lfetheme.css" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/lfe/css/pygments.css" media="screen" rel="stylesheet" type="text/css">
    <link href="/assets/css/overrides.css" rel="stylesheet" type="text/css" media="all">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="LFE News & Updates Atom Feed">
  </head>
  <body class="overview">
    <div id="header-wrapper">
      <div id="header">
        <div>
          <a class="logo" href="/">LFE Blog</a>
          <ul class="nav">
            <li><a href="/archive.html" class="nav-api">Archives</a></li>
            <li><a href="/categories.html" class="nav-developers">Categories</a></li>
            <li><a href="/tags.html" class="nav-developers">Tags</a></li>
            <li><a href="/authors.html">Authors</a></li>
            <li class="divider">|</li>
            <li><a href="http://plan.lfe.io/">.plan</a></li>
            <li><a href="http://docs.lfe.io/">docs.lfe.io</a></li>
            <li><a href="http://lfe.io/">lfe.io</a></li>
          </ul>
        </div>
      </div><!-- #header -->
    </div><!-- #header-wrapper -->

    

<div class="wrapper">
  <div class="container">
    <div class="content">
      
      <div class="page-header">
        <h1>
          LFE Friday - ETS Introduction, part 2
          
        </h1>
      </div>

      <div class="row">
        <div class="span8">
          
<p><a href="/assets/images/posts/LispFlavoredErlang-medium-square.png"><img class="left tiny" src="/assets/images/posts/LispFlavoredErlang-medium-square.png" /></a>This week's LFE Friday was translated with permission from the
<a href="http://www.proctor-it.com/category/erlang/erlang-thursday/">Erlang Thursday</a>
series by <a href="https://twitter.com/stevenproctor">Steven Proctor</a>.
<em>This week's translator</em>: Robert Virding.</p>

<p>Today's LFE Friday continues the introduction to the <a href="http://www.erlang.org/doc/man/ets.html">ets</a> module, and ETS in general.</p>

<p>We saw last time that ETS tables are destroyed when the parent process crashes, so the question comes, how might we be able to keep our ETS tables alive if we just "Let It Crash!"?</p>

<p>To solve this problem, we will take a look at the function <code>ets:give_away/3</code> and the option of specifying the <code>heir</code> at table construction.</p>

<p>First, we will create a function that will represent a process we can give the table ownership to.  This function just does a receive and never times out.</p>

<div class="highlight"><pre><code class="language-lisp"><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="nv">fun</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">()</span> <span class="p">(</span><span class="nv">receive</span> <span class="p">(</span><span class="nv">after</span> <span class="ss">&#39;infinity</span> <span class="ss">&#39;ok</span><span class="p">))))</span>
<span class="err">#</span><span class="nv">Fun&lt;lfe_eval.23.88887576&gt;</span></code></pre></div>

<p>And now with that function, we can spawn a process to run that function.</p>

<div class="highlight"><pre><code class="language-lisp"><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="nv">process</span> <span class="p">(</span><span class="nv">spawn</span> <span class="nv">fun</span><span class="p">))</span>
<span class="nv">&lt;0.36.0&gt;</span></code></pre></div>

<p>We create a new ETS Table,</p>

<div class="highlight"><pre><code class="language-lisp"><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="nv">table</span> <span class="p">(</span><span class="nv">ets:new</span> <span class="ss">&#39;table</span> <span class="p">()))</span>
<span class="mi">8207</span></code></pre></div>

<p>and give it away to the process we just spawned.</p>

<div class="highlight"><pre><code class="language-lisp"><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">ets:give_away</span> <span class="nv">table</span> <span class="nv">process</span> <span class="p">())</span>
<span class="nv">true</span></code></pre></div>

<p>We can look at the table info, and see the owner is now the process we spawned as the Pid for the process aligns with the Pid in the <code>owner</code> tuple in the table settings.</p>

<div class="highlight"><pre><code class="language-lisp"><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">ets:info</span> <span class="nv">table</span><span class="p">)</span>
<span class="p">(</span><span class="o">#(</span><span class="nv">read_concurrency</span> <span class="nv">false</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">write_concurrency</span> <span class="nv">false</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">compressed</span> <span class="nv">false</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">memory</span> <span class="mi">305</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">owner</span> <span class="nv">&lt;0.36.0&gt;</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">heir</span> <span class="nv">none</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">name</span> <span class="nv">table</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">size</span> <span class="mi">0</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">node</span> <span class="nv">nonode@nohost</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">named_table</span> <span class="nv">false</span><span class="p">)</span>
 <span class="o">#(</span><span class="k">type</span> <span class="nb">set</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">keypos</span> <span class="mi">1</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">protection</span> <span class="nv">protected</span><span class="p">))</span></code></pre></div>

<p>Now that we have supposedly transferred ownership, time to crash our current process, which is the one that was the original owner before the transfer.</p>

<div class="highlight"><pre><code class="language-lisp"><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="mi">1</span> <span class="mi">2</span><span class="p">)</span>
<span class="nv">exception</span> <span class="nv">error:</span> <span class="o">#(</span><span class="nv">badmatch</span> <span class="mi">2</span><span class="p">)</span>

<span class="nb">&gt;</span> <span class="p">(</span><span class="nv">self</span><span class="p">)</span>
<span class="nv">&lt;0.41.0&gt;</span></code></pre></div>

<p>We check if the process we spawned is still alive, mostly out of showing that there is nothing up our sleeves.</p>

<div class="highlight"><pre><code class="language-lisp"><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">is_process_alive</span> <span class="nv">process</span><span class="p">)</span>
<span class="nv">true</span></code></pre></div>

<p>And let's take a look at the "info" for the table again, and see if it is still available.</p>

<div class="highlight"><pre><code class="language-lisp"><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">ets:info</span> <span class="nv">table</span><span class="p">)</span>
<span class="p">(</span><span class="o">#(</span><span class="nv">read_concurrency</span> <span class="nv">false</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">write_concurrency</span> <span class="nv">false</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">compressed</span> <span class="nv">false</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">memory</span> <span class="mi">305</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">owner</span> <span class="nv">&lt;0.36.0&gt;</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">heir</span> <span class="nv">none</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">name</span> <span class="nv">table</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">size</span> <span class="mi">0</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">node</span> <span class="nv">nonode@nohost</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">named_table</span> <span class="nv">false</span><span class="p">)</span>
 <span class="o">#(</span><span class="k">type</span> <span class="nb">set</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">keypos</span> <span class="mi">1</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">protection</span> <span class="nv">protected</span><span class="p">))</span></code></pre></div>

<p>It is still alive!!! We did transfer ownership, so if our process crashes the ETS table still stays alive.</p>

<p>Time to kill that process</p>

<div class="highlight"><pre><code class="language-lisp"><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">exit</span> <span class="nv">process</span> <span class="s">&quot;Because&quot;</span><span class="p">)</span>
<span class="nv">true</span>
<span class="nb">&gt;</span> <span class="p">(</span><span class="nv">is_process_alive</span> <span class="nv">process</span><span class="p">)</span>
<span class="nv">false</span></code></pre></div>

<p>and watch the ETS table disappear…</p>

<div class="highlight"><pre><code class="language-lisp"><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">ets:info</span> <span class="nv">table</span><span class="p">)</span>
<span class="nv">undefined</span></code></pre></div>

<p>This time, let's use the <code>heir</code> option when creating an ETS table, and take advantage of the magic of ownership transfer for an ETS table to a heir.</p>

<p>In this case, the shell will be the heir when the owning process dies.</p>

<div class="highlight"><pre><code class="language-lisp"><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="nv">table-with-heir</span> <span class="p">(</span><span class="nv">ets:new</span> <span class="ss">&#39;table</span> <span class="p">(</span><span class="nb">list</span> <span class="p">(</span><span class="nv">tuple</span> <span class="ss">&#39;heir</span> <span class="p">(</span><span class="nv">self</span><span class="p">)</span> <span class="s">&quot;something went wrong&quot;</span><span class="p">))))</span>
<span class="mi">12303</span></code></pre></div>

<p>We create a new process, and assign ownership of the ETS table to the new process.</p>

<div class="highlight"><pre><code class="language-lisp"><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="nv">process-2</span> <span class="p">(</span><span class="nv">spawn</span> <span class="nv">fun</span><span class="p">))</span>
<span class="nv">&lt;0.50.0&gt;</span>
<span class="nb">&gt;</span> <span class="p">(</span><span class="nv">ets:give_away</span> <span class="nv">table-with-heir</span> <span class="nv">process-2</span> <span class="p">())</span>
<span class="nv">true</span></code></pre></div>

<p>We then look at the info for the table, and we can see both the owner is the new process, and the heir is our current process.</p>

<div class="highlight"><pre><code class="language-lisp"><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">self</span><span class="p">)</span>
<span class="nv">&lt;0.41.0&gt;</span>
<span class="nb">&gt;</span> <span class="p">(</span><span class="nv">ets:info</span> <span class="nv">table-with-heir</span><span class="p">)</span>
<span class="p">(</span><span class="o">#(</span><span class="nv">read_concurrency</span> <span class="nv">false</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">write_concurrency</span> <span class="nv">false</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">compressed</span> <span class="nv">false</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">memory</span> <span class="mi">349</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">owner</span> <span class="nv">&lt;0.50.0&gt;</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">heir</span> <span class="nv">&lt;0.41.0&gt;</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">name</span> <span class="nv">table</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">size</span> <span class="mi">0</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">node</span> <span class="nv">nonode@nohost</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">named_table</span> <span class="nv">false</span><span class="p">)</span>
 <span class="o">#(</span><span class="k">type</span> <span class="nb">set</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">keypos</span> <span class="mi">1</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">protection</span> <span class="nv">protected</span><span class="p">))</span></code></pre></div>

<p>Time to kill the owning process again…</p>

<div class="highlight"><pre><code class="language-lisp"><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">exit</span> <span class="nv">process-2</span> <span class="s">&quot;Because&quot;</span><span class="p">)</span>
<span class="nv">true</span>
<span class="nb">&gt;</span> <span class="p">(</span><span class="nv">is_process_alive</span> <span class="nv">process-2</span><span class="p">)</span>
<span class="nv">false</span></code></pre></div>

<p>And if we inspect the table info again, we can see the current process is now both the owner and the heir.</p>

<div class="highlight"><pre><code class="language-lisp"><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">ets:info</span> <span class="nv">table-with-heir</span><span class="p">)</span>
<span class="p">(</span><span class="o">#(</span><span class="nv">read_concurrency</span> <span class="nv">false</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">write_concurrency</span> <span class="nv">false</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">compressed</span> <span class="nv">false</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">memory</span> <span class="mi">349</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">owner</span> <span class="nv">&lt;0.41.0&gt;</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">heir</span> <span class="nv">&lt;0.41.0&gt;</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">name</span> <span class="nv">table</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">size</span> <span class="mi">0</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">node</span> <span class="nv">nonode@nohost</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">named_table</span> <span class="nv">false</span><span class="p">)</span>
 <span class="o">#(</span><span class="k">type</span> <span class="nb">set</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">keypos</span> <span class="mi">1</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">protection</span> <span class="nv">protected</span><span class="p">))</span></code></pre></div>

<p>We spawn up a new process, and we give the table to that new process.</p>

<div class="highlight"><pre><code class="language-lisp"><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">set</span> <span class="nv">process-3</span> <span class="p">(</span><span class="nv">spawn</span> <span class="nv">fun</span><span class="p">))</span>
<span class="nv">&lt;0.57.0&gt;</span>
<span class="nb">&gt;</span> <span class="p">(</span><span class="nv">ets:give_away</span> <span class="nv">table-with-heir</span> <span class="nv">process-3</span> <span class="p">())</span>
<span class="nv">true</span></code></pre></div>

<p>The owner now becomes that new process, and our current process is still the heir.</p>

<div class="highlight"><pre><code class="language-lisp"><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">ets:info</span> <span class="nv">table-with-heir</span><span class="p">)</span>
<span class="p">(</span><span class="o">#(</span><span class="nv">read_concurrency</span> <span class="nv">false</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">write_concurrency</span> <span class="nv">false</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">compressed</span> <span class="nv">false</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">memory</span> <span class="mi">349</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">owner</span> <span class="nv">&lt;0.57.0&gt;</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">heir</span> <span class="nv">&lt;0.41.0&gt;</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">name</span> <span class="nv">table</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">size</span> <span class="mi">0</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">node</span> <span class="nv">nonode@nohost</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">named_table</span> <span class="nv">false</span><span class="p">)</span>
 <span class="o">#(</span><span class="k">type</span> <span class="nb">set</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">keypos</span> <span class="mi">1</span><span class="p">)</span>
 <span class="o">#(</span><span class="nv">protection</span> <span class="nv">protected</span><span class="p">))</span></code></pre></div>

<p>So by taking advantage of the ability to specify a heir, and using <code>ets:give_away/3</code>, we can help keep the ETS table alive.</p>

<p>One way this might be taken advantage of is that we have a supervisor create a "heir" process, and then create the child process that would own the ETS table, and if the child dies, it can then transfer ownership back to the heir process until the new "owning" process can be restarted, and then the heir process can then transfer ownership of the ETS table to the "newly restarted" process.</p>

<p>- Proctor, Robert</p>

          <hr>
          <div class="pagination btn-group">
            
            <a class="btn prev" href="/tutorials/2015/11/28/2110-lfe-yaws-docker-update" title="Update: Running an LFE YAWS app in Docker">&larr; Previous</a>
            
            <a class="btn" href="/archive.html">Archive</a>
            
            <a class="btn next" href="/tutorials/2015/12/12/1716-lfe-friday---ets-introduction-part-3" title="LFE Friday - ETS Introduction, part 3: ETS Table Types">Next &rarr;</a>
            
          </div>
          <hr>
          
        </div>

        <div class="span4">
          <section>
            <h4>Author</h4>
            <div class="author"><span><a href="/authors.html#Robert Virding">Robert Virding</a></span></div>
          </section>
          <section>
            <h4>Published</h4>
            <div class="date"><span>05 December 2015</span></div>
          </section>
          
          <section>
            <h4>Category</h4>
            <span class="category">
              tutorials
            </span>
          </section>
          
          
          <section>
            <h4>Tags</h4>
            <ul class="tag_box">
              
              


  
     
    	<li><a href="/tags.html#lfe friday-ref">lfe friday <span>58</span></a></li>
     
    	<li><a href="/tags.html#lfe-ref">lfe <span>63</span></a></li>
     
    	<li><a href="/tags.html#erlang-ref">erlang <span>71</span></a></li>
    
  



            </ul>
          </section>
          
        </div>
      </div>


    </div>
  </div> <!-- /container -->
</div>




    <div id="footer" >
    <div class="lower_footer">
      <ul class="footer-cell">
        <li><a href="/archive.html">Archives</a></li>
        <li><a href="/categories.html">Categories</a></li>
        <li><a href="/tags.html">Tags</a></li>
        <li><a href="/authors.html">Authors</a></li>
        <li><a href="/pages.html">Pages</a></li>
      </ul>

      <span class="footer-cell">
        <a href="/"><img src="/assets/themes/lfe/images/logo-white.png"/></a>
      </span>

      <ul class="footer-cell">
        <li><a href="http://github.com/lfex">lfex</a></li>
        <li><a href="https://groups.google.com/forum/#!forum/lisp-flavoured-erlang">List</a></li>
        <li><a href="http://webchat.freenode.net/?channels=erlang-lisp">IRC</a></li>
        <li><a href="http://feeds.feedburner.com/lfe/news-and-updates">RSS</a></li>
        <li><a href="http://twitter.com/ErlangLisp">Twitter</a></li>
        <li><a href="http://github.com/rvirding/lfe">Github</a></li>
      </ul>
    </div>

    <div class="wrapper">
      <p>Original Design &copy; <span class="js-year"></span> GitHub, Inc.</p>
      <p>LFE Design and Content &copy; <span class="js-year"></span> LFEuminati | Alien Alliance</p>
    </div>

  </div><!-- /#footer -->

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="/assets/themes/lfe/js/jquery.min.js"><\/script>')</script>
    <script src="/assets/themes/lfe/bootstrap/js/bootstrap.min.js"></script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-38274766-2', 'auto');
      ga('send', 'pageview');

    </script>
  </body>
</html>

